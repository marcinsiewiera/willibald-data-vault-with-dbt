


-----------------------------------------------------------------------------------------------
--                                                                                      ( )  --
--                                                                                     //    --
--                                                                               ( )=( o )   --
--  #####   #####     #    #       ####### ####### ######  ####### #######             \\    --
-- #     # #     #   # #   #       #       #       #     # #       #                    ( )  --
-- #       #        #   #  #       #       #       #     # #       #                         --
--  #####  #       #     # #       #####   #####   ######  #####   #####                     --
--       # #       ####### #       #       #       #   #   #       #                         --
-- #     # #     # #     # #       #       #       #    #  #       #                         --
--  #####   #####  #     # ####### ####### #       #     # ####### #######                   --
-----------------------------------------------------------------------------------------------
--              Generated by datavault4dbt by Scalefree International GmbH                   --
-----------------------------------------------------------------------------------------------

WITH

pit_records AS (

    SELECT
        
        '"REGULAR PIT"' as type,
        'PIT table for position_product' as rsrc,
        IFNULL(LOWER(MD5(NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(CONCAT(
    IFNULL((CONCAT('\"', REPLACE(REPLACE(REPLACE(TRIM(CAST('Regular PIT' AS STRING)), '\\', '\\\\'), '"', '\"'), '^^', '--'), '\"')), '^^'),'||',
        
    IFNULL((CONCAT('\"', REPLACE(REPLACE(REPLACE(TRIM(CAST(te.hk_position_product_l AS STRING)), '\\', '\\\\'), '"', '\"'), '^^', '--'), '\"')), '^^'),'||',
        
    IFNULL((CONCAT('\"', REPLACE(REPLACE(REPLACE(TRIM(CAST(snap.sdts AS STRING)), '\\', '\\\\'), '"', '\"'), '^^', '--'), '\"')), '^^')
    ), '\n', '') 
    , '\t', '') 
    , '\v', '') 
    , '\r', '') AS STRING), '^^||^^||^^'))), '00000000000000000000000000000000') AS hk_position_product_d ,
        te.hk_position_product_l,
        snap.sdts,
            COALESCE(position_product_rs_es.hk_position_product_l, CAST('00000000000000000000000000000000' as STRING)) AS hk_position_product_rs_es,
            COALESCE(position_product_rs_es.ldts, TO_TIMESTAMP('0001-01-01T00:00:01', 'YYYY-MM-DDTHH24:MI:SS')) AS ldts_position_product_rs_es,
            COALESCE(position_product_rs_sts.hk_position_product_l, CAST('00000000000000000000000000000000' as STRING)) AS hk_position_product_rs_sts,
            COALESCE(position_product_rs_sts.ldts, TO_TIMESTAMP('0001-01-01T00:00:01', 'YYYY-MM-DDTHH24:MI:SS')) AS ldts_position_product_rs_sts,
            COALESCE(position_product_ws_es.hk_position_product_l, CAST('00000000000000000000000000000000' as STRING)) AS hk_position_product_ws_es,
            COALESCE(position_product_ws_es.ldts, TO_TIMESTAMP('0001-01-01T00:00:01', 'YYYY-MM-DDTHH24:MI:SS')) AS ldts_position_product_ws_es,
            COALESCE(position_product_ws_sts.hk_position_product_l, CAST('00000000000000000000000000000000' as STRING)) AS hk_position_product_ws_sts,
            COALESCE(position_product_ws_sts.ldts, TO_TIMESTAMP('0001-01-01T00:00:01', 'YYYY-MM-DDTHH24:MI:SS')) AS ldts_position_product_ws_sts

    FROM
            WILLIBALD_DATA_VAULT_WITH_DBT.dwh_04_rv.position_product_l te
        FULL OUTER JOIN
            WILLIBALD_DATA_VAULT_WITH_DBT.dwh_03_stage.control_snap_v1 snap
            ON snap.is_active = true
            
        
        LEFT JOIN WILLIBALD_DATA_VAULT_WITH_DBT.dwh_04_rv.position_product_rs_es
            ON
                position_product_rs_es.hk_position_product_l = te.hk_position_product_l
                AND snap.sdts BETWEEN position_product_rs_es.ldts AND position_product_rs_es.ledts
        
        LEFT JOIN (
            SELECT
                hk_position_product_l,
                ldts,
                COALESCE(LEAD(ldts - INTERVAL '1 MICROSECOND') OVER (PARTITION BY hk_position_product_l ORDER BY ldts),TO_TIMESTAMP('8888-12-31T23:59:59', 'YYYY-MM-DDTHH24:MI:SS')) AS ledts
            FROM WILLIBALD_DATA_VAULT_WITH_DBT.dwh_04_rv.position_product_rs_sts
        ) position_product_rs_sts
        
            ON
                position_product_rs_sts.hk_position_product_l = te.hk_position_product_l
                AND snap.sdts BETWEEN position_product_rs_sts.ldts AND position_product_rs_sts.ledts
        
        LEFT JOIN WILLIBALD_DATA_VAULT_WITH_DBT.dwh_04_rv.position_product_ws_es
            ON
                position_product_ws_es.hk_position_product_l = te.hk_position_product_l
                AND snap.sdts BETWEEN position_product_ws_es.ldts AND position_product_ws_es.ledts
        
        LEFT JOIN (
            SELECT
                hk_position_product_l,
                ldts,
                COALESCE(LEAD(ldts - INTERVAL '1 MICROSECOND') OVER (PARTITION BY hk_position_product_l ORDER BY ldts),TO_TIMESTAMP('8888-12-31T23:59:59', 'YYYY-MM-DDTHH24:MI:SS')) AS ledts
            FROM WILLIBALD_DATA_VAULT_WITH_DBT.dwh_04_rv.position_product_ws_sts
        ) position_product_ws_sts
        
            ON
                position_product_ws_sts.hk_position_product_l = te.hk_position_product_l
                AND snap.sdts BETWEEN position_product_ws_sts.ldts AND position_product_ws_sts.ledts
        
    
        WHERE snap.is_active

),

records_to_insert AS (

    SELECT DISTINCT *
    FROM pit_records)

SELECT * FROM records_to_insert